name: Build Exemplo App

on:
  push:
    branches: [main, master]
    paths:
      - 'exemplo-app/**'
      - '.github/workflows/build-exemplo-app.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'exemplo-app/**'
  workflow_dispatch:

env:
  REGISTRY: registry.tasso.dev.br
  IMAGE_NAME: exemplo-app

jobs:
  build:
    name: Build Exemplo App
    runs-on: github-runner-set
    
    steps:
      - name: Aguardar Docker daemon
        run: |
          echo "â³ Aguardando Docker daemon iniciar..."
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "âœ… Docker daemon pronto!"
              break
            fi
            echo "Tentativa $i/30..."
            sleep 2
          done
          docker version
      
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Build da imagem Docker
        run: |
          cd exemplo-app
          docker build \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            -t ${REGISTRY}/${IMAGE_NAME}:latest \
            -t ${REGISTRY}/${IMAGE_NAME}:${{ github.sha }} \
            .
      
      - name: Verificar imagem
        run: |
          echo "ðŸ“‹ Imagem construÃ­da:"
          docker images | grep ${IMAGE_NAME}
      
      - name: Testar imagem
        run: |
          echo "ðŸ§ª Testando a imagem..."
          docker run --rm ${REGISTRY}/${IMAGE_NAME}:latest echo "Container executou com sucesso!"
      
      - name: Push da imagem
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸš€ Enviando imagens para o registry..."
          docker push ${REGISTRY}/${IMAGE_NAME}:latest
          docker push ${REGISTRY}/${IMAGE_NAME}:${{ github.sha }}
          echo "âœ… Push concluÃ­do!"
      
      - name: Resumo do Build
        run: |
          echo "## ðŸ³ Build da Imagem exemplo-app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | \`${REGISTRY}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Imagem** | \`${IMAGE_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${REGISTRY}/${IMAGE_NAME}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
